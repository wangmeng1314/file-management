{
  "title": "JVM相关问题排查",
  "cells": [
    {
      "type": "text",
      "data": "重新加载<div>放入component continer</div><div>直接取出instance，instance没有状态的，新建classLoader进行装配并生成实例，即可</div><div>这也是metaSpace空间不足的原因了</div><div><br></div><div>为啥metaSpace没有卸载掉，这是因为什么？</div><div><br></div><div>ModuleHolder是一个Map，也正因为此，当生成新的实例的时候，只是没有地方引用到老的实例了</div><div><br></div><div><ul style=\"border: 0px; margin: 0px 0px 20px; padding: 0px; font-size: 14px; list-style-position: inside; list-style-image: initial; color: rgb(0, 0, 0); font-family: 'Microsoft YaHei', 宋体, 'Myriad Pro', Lato, 'Helvetica Neue', Helvetica, Arial, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><li style=\"border: 0px; margin: 0px; padding: 0px;\">该类所有的实例都已经被GC。</li><li style=\"border: 0px; margin: 0px; padding: 0px;\">加载该类的ClassLoader实例已经被GC。</li><li style=\"border: 0px; margin: 0px; padding: 0px;\">该类的java.lang.Class对象没有在任何地方被引用。</li></ul><div style=\"orphans: 2; widows: 2;\"><font face=\"Microsoft YaHei, 宋体, Myriad Pro, Lato, Helvetica Neue, Helvetica, Arial, sans-serif\"><span style=\"font-size: 14px;\"><br></span></font></div></div><div style=\"orphans: 2; widows: 2;\"><font face=\"Microsoft YaHei, 宋体, Myriad Pro, Lato, Helvetica Neue, Helvetica, Arial, sans-serif\"><span style=\"font-size: 14px;\">jad指令发现ClassLoader所加载的Class是被卸载的了。</span></font></div><div style=\"orphans: 2; widows: 2;\"><font face=\"Microsoft YaHei, 宋体, Myriad Pro, Lato, Helvetica Neue, Helvetica, Arial, sans-serif\"><span style=\"font-size: 14px;\">jad指令实现的机制是？</span></font></div><div style=\"orphans: 2; widows: 2;\"><font face=\"Microsoft YaHei, 宋体, Myriad Pro, Lato, Helvetica Neue, Helvetica, Arial, sans-serif\"><span style=\"font-size: 14px;\">热部署的机制</span></font></div><div style=\"orphans: 2; widows: 2;\"><font face=\"Microsoft YaHei, 宋体, Myriad Pro, Lato, Helvetica Neue, Helvetica, Arial, sans-serif\"><span style=\"font-size: 14px;\"><br></span></font></div><div style=\"orphans: 2; widows: 2;\"><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\"><span style=\"color:#c3e88d;\">SpringFactoriesLoader 在部分版本可能存在缓存</span></pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\"><span style=\"color:#c3e88d;\"><br></span></pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\"><span style=\"color:#c3e88d;\">jstat -class 确认可以查找到classloader的相关信息，包含卸载及增加等的信息</span></pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\">同时观察metaspace的容量占用以及占用比例，确认是可以进行卸载的</pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\"><br></pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\">同时arthas的jad指令，也是能够证明这个问题的</pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\"><br></pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\">附上<a href=\"http://www.cellei.com/blog/2018/06231\" style=\"font-size: 13px; font-family: -apple-system, Helvetica, Arial, sans-serif;\">http://www.cellei.com/blog/2018/06231</a> </pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\">jstat的用法。</pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\">- 实际对于java开发而言，JVM的两种行为最难琢磨</pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\">1、内存垃圾回收等</pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\">2、编译信息，比如JIT等信息的获取</pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\">比如我们再重启机器或者扩容的时候经常会遇到估算容量不准确的问题，这就是比较尴尬的。</pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\"><span style=\"color:#c3e88d;\"><br></span></pre><pre style=\"background-color:#212121;color:#eeffff;font-family:'Source Code Pro';font-size:9.8pt;\">Java agent是在编译期加载东西</pre></div><div style=\"orphans: 2; widows: 2;\"><font face=\"Microsoft YaHei, 宋体, Myriad Pro, Lato, Helvetica Neue, Helvetica, Arial, sans-serif\"><span style=\"font-size: 14px;\"><br></span></font></div><div><br></div><div><br></div><div><br></div>"
    }
  ]
}